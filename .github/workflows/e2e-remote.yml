# This workflow is to test the action as if run by a remote repository.
name: E2E Test Remote

on: push

env:
  GITOPS_REPOSITORY: kzap/gitops-push
  GITOPS_BRANCH: gitops-ci-${{ github.run_id }}-${{ github.run_attempt }}

jobs:
  e2e-test:
    name: End-to-End Test
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        environment:
          - test-env
    environment: ${{ matrix.environment }}
    steps:
      - name: Test Remote Action
        id: test-action
        # Testing
        #uses: kzap/gitops-push@main
        uses: kzap/gitops-push@amt/test-remote-action
        with:
          gitops-token: ${{ github.token }}
          gitops-repository: kzap/gitops-push
          gitops-branch:
            gitops-ci-${{ github.run_id }}-${{ github.run_attempt }}
          gitops-path: e2e-test-gitops-repo
          environment: ${{ matrix.environment }}
          application-manifests-path: ./__fixtures__/helm/argocd-app/

      - name: Checkout GitOps Repository
        id: checkout-gitops
        uses: actions/checkout@v5
        with:
          repository: ${{ env.GITOPS_REPOSITORY }}
          ref: ${{ env.GITOPS_BRANCH }}
          path: gitops-repo-temp-dir

      - name: Verify Generated YAML Structure
        id: verify-yaml
        run: |
          cd ./gitops-repo-temp-dir/e2e-test-gitops-repo

          tree -L 2 -a ./ -I 'node_modules'

          # Find and verify the ApplicationSet YAML file
          # Look specifically for ApplicationSet files in the applicationsets directory
          YAML_FILE=$(find ./application-sets -name "*.yaml" -o -name "*.yml" | head -1)
          if [ -z "$YAML_FILE" ]; then
            echo "‚ùå No ApplicationSet YAML file found in applicationsets directory"
            echo "üìÅ Directory structure:"
            find . -type f -name "*.yml" -o -name "*.yaml" | head -10
            exit 1
          fi

          echo "üìÑ Found YAML file: $YAML_FILE"
          echo "üìã YAML Content:" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>YAML Content</summary>" >> $GITHUB_STEP_SUMMARY
          echo "<br>" >> $GITHUB_STEP_SUMMARY
          echo "```yaml" >> $GITHUB_STEP_SUMMARY
          cat "$YAML_FILE" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

          # Validate YAML syntax
          if ! yq eval '.' "$YAML_FILE" > /dev/null 2>&1; then
            echo "‚ùå Invalid YAML syntax"
            exit 1
          fi

          # Verify ApplicationSet structure
          API_VERSION=$(yq eval '.apiVersion' "$YAML_FILE")
          KIND=$(yq eval '.kind' "$YAML_FILE")
          APP_NAME=$(yq eval '.metadata.name' "$YAML_FILE")
          NAMESPACE=$(yq eval '.metadata.namespace' "$YAML_FILE")
          REPO_URL=$(yq eval '.spec.generators[0].git.repoURL' "$YAML_FILE")
          ENVIRONMENT_PATH=$(yq eval '.spec.generators[0].git.directories[0].path' "$YAML_FILE")

          echo "üîç Verifying ApplicationSet fields:"
          echo "  apiVersion: $API_VERSION"
          echo "  kind: $KIND"
          echo "  metadata.name: $APP_NAME"
          echo "  metadata.namespace: $NAMESPACE"
          echo "  spec.generators[0].git.repoURL: $REPO_URL"
          echo "  spec.generators[0].git.directories[0].path: $ENVIRONMENT_PATH"

          # Validate required fields
          if [ "$API_VERSION" != "argoproj.io/v1alpha1" ]; then
            echo "‚ùå Invalid apiVersion: expected 'argoproj.io/v1alpha1', got '$API_VERSION'"
            exit 1
          fi

          if [ "$KIND" != "ApplicationSet" ]; then
            echo "‚ùå Invalid kind: expected 'ApplicationSet', got '$KIND'"
            exit 1
          fi

          if [ "$NAMESPACE" != "argocd" ]; then
            echo "‚ùå Invalid namespace: expected 'argocd', got '$NAMESPACE'"
            exit 1
          fi

          if [[ "$REPO_URL" != *"github.com"* ]]; then
            echo "‚ùå Invalid repoURL: expected GitHub URL, got '$REPO_URL'"
            exit 1
          fi

          if [[ "$ENVIRONMENT_PATH" != *"${{ matrix.environment }}"* ]]; then
            echo "‚ùå Invalid environment path: expected to contain '${{ matrix.environment }}', got '$ENVIRONMENT_PATH'"
            exit 1
          fi

          # Verify ArgoCD template variables are preserved
          if ! grep -q "{{path.basename}}" "$YAML_FILE"; then
            echo "‚ùå ArgoCD template variable {{path.basename}} not found in YAML"
            exit 1
          fi

          if ! grep -q "{{path}}" "$YAML_FILE"; then
            echo "‚ùå ArgoCD template variable {{path}} not found in YAML"
            exit 1
          fi

          echo "‚úÖ All YAML structure validations passed!"
          echo "‚úÖ ApplicationSet manifest is properly formatted"
          echo "‚úÖ Input values correctly mapped to output YAML"
          echo "‚úÖ ArgoCD template variables preserved"
